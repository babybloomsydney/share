<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanny Profile Preview</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    body{background:#f0f2f5;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;padding:20px;margin:0;}
    .copy-container{display:flex;gap:6px;margin-bottom:12px;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap;}
    .copy-btn,.share-btn,.return-btn{
      background:#1877F2;color:white;border:none;padding:8px 12px;font-size:13px;font-weight:600;
      border-radius:6px;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:background .2s ease;
      min-width:0;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;
    }
    .copy-btn:hover,.share-btn:hover,.return-btn:hover{background:#1666d1;}
    .copy-btn.copied,.share-btn.copied,.return-btn.copied{background:#4B8BF4;}
    .fb-post{width:500px;max-width:100%;border:1px solid #ddd;border-radius:8px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);}
    .fb-header{display:flex;align-items:center;padding:12px;}
    .fb-header img{width:40px;height:40px;border-radius:50%;margin-right:10px;}
    .fb-header .fb-user-name{font-weight:bold;font-size:14px;color:#050505;}
    .fb-header .fb-time{font-size:12px;color:#65676b;}
    .fb-content{padding:0 12px 12px;font-size:14px;line-height:1.45;color:#050505;}
    .fb-content p{margin:0;word-break:break-word;display:inline;}
    .fb-reactions-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 12px 8px;border-top:1px solid #ddd;font-size:13px;line-height:1;}
    .fb-reactions{display:inline-flex;align-items:center;gap:5px;}
    .reaction-icons-img{width:38px;height:18px;vertical-align:-2px;image-rendering:crisp-edges;}
    .fb-reactions span,.fb-comments-count{color:#65676b;font-weight:600;cursor:pointer;}
    .fb-reactions span:hover,.fb-comments-count:hover{text-decoration:underline;}
    .fb-footer{display:flex;justify-content:space-around;border-top:1px solid #ddd;padding:8px 0;font-size:14px;color:#65676b;}
    .fb-footer div{cursor:pointer;padding:6px 0;text-align:center;flex:1;user-select:none;}
    .fb-footer div:hover{background:#f2f2f2;border-radius:4px;}
    .fb-link-preview{border:1px solid #ddd;border-radius:6px;margin:12px;overflow:hidden;background:#f8f9fa;}
    .fb-link-preview img{width:100%;display:block;object-fit:cover;}
    .fb-link-text{padding:8px;}
    .fb-link-text .domain{font-size:11px;color:#65676b;margin-bottom:2px;}
    .fb-link-text .title{font-weight:bold;font-size:14px;color:#050505;margin-bottom:2px;}
    .fb-link-text .description{font-size:13px;color:#050505;}
    #loader{text-align:center;margin:40px;font-size:16px;color:#666;}
    .error{color:red;text-align:center;margin:40px;}
  </style>
</head>
<body>
<div id="loader">Loading your profile...</div>
<div class="copy-container" style="display:none;">
  <button class="copy-btn" id="copyBtn">Copy Post</button>
  <button class="share-btn" id="shareBtn">Share Profile</button>
  <button class="return-btn" id="returnBtn" style="display:none;">Return To Profile</button>
</div>
<div class="fb-post" style="display:none;">
  <div class="fb-header">
    <img id="profilePic" src="" alt="Profile">
    <div>
      <div class="fb-user-name" id="userName">Loading...</div>
      <div class="fb-time">Just now</div>
    </div>
  </div>
  <div class="fb-content" id="postText"><p>Loading...</p></div>
  <div class="fb-link-preview">
    <img id="previewImage" src="" alt="Preview">
    <div class="fb-link-text">
      <div class="domain">BABYBLOOMSYDNEY.COM.AU</div>
      <div class="title" id="previewTitle">Loading...</div>
      <div class="description" id="previewDesc">Loading...</div>
    </div>
  </div>
  <div class="fb-reactions-bar">
    <div class="fb-reactions">
      <img src="https://drive.google.com/thumbnail?id=1fYJDK5-RDUYNw7smpK0TKKBxU4suCdq6&sz=w2000-h1050" class="reaction-icons-img" alt="Reactions">
      <span>12</span>
    </div>
    <div class="fb-comments-count">6 comments</div>
  </div>
  <div class="fb-footer">
    <div>Like</div><div>Comment</div><div>Share</div>
  </div>
</div>
<script>
  // === CONFIG (REPLACE WITH YOUR GAS URL) ===
  const API_URL = "https://script.google.com/macros/s/AKfycby20aEBgcsUv4f-JauOQKM6Dn7wwou2fu2Rc6RRzR0B9rZcVCrawTv4v0QlZDiRxfU4ig/exec";  // Your GAS URL

  // === HELPER: SEND REQUEST TO GAS ===
  async function sendRequest(payload) {
    try {
      console.log('Sending GAS request: ' + JSON.stringify(payload));  // NEW: Log payload
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
        redirect: "follow"
      });
      console.log('GAS response code: ' + response.status);  // NEW: Log code
      if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
      const json = await response.json();
      console.log('GAS response data: ' + JSON.stringify(json));  // NEW: Log response
      return json;
    } catch (e) {
      console.error("API Error: " + e.message);  // Log error
      throw new Error("Failed to fetch profile data. Please try again.");
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const loader = document.getElementById('loader');
    try {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      console.log('Extracted token: ' + (token ? '[provided]' : '[missing]'));  // NEW: Log token
      if (!token) throw new Error('No authentication token provided');

      // Fetch data via GAS (replaces param parsing)
      const res = await sendRequest({ action: "verifyTokenAndFetchParams", token });
      if (res.status !== 'success') throw new Error(res.message || 'Invalid or expired token');
      const data = res.data;
      if (!data.contactId) throw new Error('Invalid profile data');

      renderPreview(data);

      // Optional: Clear token from URL for security (prevents bookmarking)
      history.replaceState(null, '', window.location.pathname);
    } catch (err) {
      console.error('Load error: ' + err.message);  // NEW: Log load error
      loader.innerHTML = `<div class="error">Error: ${err.message}</div>`;
    }
  });

  function renderPreview(data) {
    document.getElementById('loader').remove();
    document.querySelector('.copy-container').style.display = 'flex';
    document.querySelector('.fb-post').style.display = 'block';
    document.getElementById('profilePic').src = data.profilePicture || 'https://randomuser.me/api/portraits/women/44.jpg';
    document.getElementById('userName').textContent = data.firstName;
    document.getElementById('previewImage').src = data.nanny_ad || data.profilePicture || '';
    document.getElementById('previewTitle').textContent = `Experienced Nanny Available | ${data.suburb}`;
    document.getElementById('previewDesc').textContent = `Hi, I'm ${data.firstName} and I'm now available to Nanny!`;
    const bio = data.bioNanny.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
    document.getElementById('postText').innerHTML = `<p>${bio}</p>`;
    // === ADD DYNAMIC OG TAGS ===
    const head = document.head;
    const ogTags = [
      { property: 'og:title', content: `ðŸ’« Experienced Nanny Available ðŸ’« | ${data.suburb}` },
      { property: 'og:description', content: `Hi, I'm ${data.firstName} and I'm now available to Nanny!` },
      { property: 'og:image', content: data.nanny_ad || data.profilePicture },
      { property: 'og:url', content: `https://babybloomsydney.com.au/nanny/${data.contactId}` },
      { property: 'og:type', content: 'profile' }
    ];
    ogTags.forEach(tag => {
      let meta = head.querySelector(`meta[property="${tag.property}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.property = tag.property;
        head.appendChild(meta);
      }
      meta.content = tag.content;
    });
  }
  // === COPY POST - CLEAN TEXT ONLY ===
  document.getElementById('copyBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const postEl = document.getElementById('postText');
    const clone = postEl.cloneNode(true);
    clone.innerHTML = clone.innerHTML.replace(/<br\s*\/?>/gi, '\n');
    let text = clone.textContent.trim();
    text = text.split('\n').map(l => l.trim()).join('\n');
    let copied = false;
    if (navigator.clipboard) {
      try { await navigator.clipboard.writeText(text); copied = true; } catch (e) {}
    }
    if (!copied) {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      copied = document.execCommand('copy');
      document.body.removeChild(ta);
    }
    if (copied) {
      e.target.textContent = 'Post Copied';
      e.target.classList.add('copied');
      setTimeout(() => {
        e.target.textContent = 'Copy Post';
        e.target.classList.remove('copied');
      }, 1000);
    }
  });
  // === SHARE PROFILE - SHOW RETURN BUTTON ON SUCCESS ===
  document.getElementById('shareBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    let contactId = '';
    try {
      // Fetch contactId from rendered data (no need to re-fetch)
      contactId = document.querySelector('meta[property="og:url"]').content.split('/').pop();
    } catch (err) {}
    const nannyUrl = `https://babybloomsydney.com.au/nanny/${contactId}`;
    const shareData = {
      title: document.getElementById('previewTitle').textContent,
      text: document.getElementById('previewDesc').textContent,
      url: nannyUrl
    };
    if (navigator.share) {
      try {
        await navigator.share(shareData);
        e.target.textContent = 'Shared!';
        e.target.classList.add('copied');
        setTimeout(() => {
          e.target.textContent = 'Share Profile';
          e.target.classList.remove('copied');
        }, 1000);
        // === SHOW RETURN BUTTON ON SUCCESS ===
        document.getElementById('returnBtn').style.display = 'inline-block';
      } catch (err) {
        alert('Share failed.');
      }
    } else {
      navigator.clipboard.writeText(nannyUrl).then(() => {
        e.target.textContent = 'URL Copied!';
        e.target.classList.add('copied');
        setTimeout(() => {
          e.target.textContent = 'Share Profile';
          e.target.classList.remove('copied');
        }, 1000);
      });
    }
  });
  // === RETURN TO PROFILE BUTTON ===
  document.getElementById('returnBtn').addEventListener('click', (e) => {
    let contactId = '';
    try {
      // Fetch contactId from rendered data (no need to re-parse)
      contactId = document.querySelector('meta[property="og:url"]').content.split('/').pop();
    } catch (err) {}
    window.location.href = `https://babybloomsydney.com.au/nanny/${contactId}`;
  });
</script>
</body>
</html>
