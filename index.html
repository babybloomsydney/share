<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanny Profile Preview</title>
  <!-- ADDED PAKO BACK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <style>
    body { background: #f0f2f5; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
    #security-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1877F2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #sec-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #333; }
    #sec-desc { font-size: 14px; color: #666; max-width: 400px; line-height: 1.5; }
    #app-container { display: none; width: 100%; max-width: 550px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
    .copy-container { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; width: 100%; justify-content: center; }
    .copy-btn, .share-btn, .return-btn { background: #1877F2; color: white; border: none; padding: 8px 12px; font-size: 13px; font-weight: 600; border-radius: 6px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,.1); transition: background .2s ease; }
    .copy-btn:hover, .share-btn:hover, .return-btn:hover { background: #1666d1; }
    .copy-btn.copied, .share-btn.copied, .return-btn.copied { background: #4B8BF4; }
    .fb-post { width: 500px; max-width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.1); }
    .fb-header { display: flex; align-items: center; padding: 12px; }
    .fb-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .fb-header .fb-user-name { font-weight: bold; font-size: 14px; color: #050505; }
    .fb-header .fb-time { font-size: 12px; color: #65676b; }
    .fb-content { padding: 0 12px 12px; font-size: 14px; line-height: 1.45; color: #050505; }
    .fb-content p { margin: 0; word-break: break-word; }
    .fb-link-preview { border: 1px solid #ddd; border-radius: 6px; margin: 12px; overflow: hidden; background: #f8f9fa; cursor: pointer; }
    .fb-link-preview img { width: 100%; display: block; object-fit: cover; aspect-ratio: 1.91/1; }
    .fb-link-text { padding: 10px 12px; border-top: 1px solid #ddd; background: #f0f2f5; }
    .fb-link-text .domain { font-size: 12px; color: #65676b; text-transform: uppercase; margin-bottom: 2px; }
    .fb-link-text .title { font-weight: bold; font-size: 16px; color: #050505; margin-bottom: 2px; line-height: 1.2; }
    .fb-link-text .description { font-size: 13px; color: #65676b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .fb-reactions-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-top: 1px solid #ddd; font-size: 13px; color: #65676b; }
    .fb-reactions { display: inline-flex; align-items: center; gap: 5px; }
    .reaction-icons-img { width: 38px; height: 18px; }
    .fb-footer { display: flex; justify-content: space-around; border-top: 1px solid #ddd; padding: 4px 0; }
    .fb-footer div { padding: 6px 0; text-align: center; flex: 1; font-size: 14px; font-weight: 600; color: #65676b; cursor: pointer; border-radius: 4px; margin: 0 4px; }
    .fb-footer div:hover { background: #f2f2f2; }
  </style>
</head>
<body>
  <div id="security-overlay">
    <div class="spinner" id="sec-spinner"></div>
    <div id="sec-title">Verifying Access</div>
    <div id="sec-desc">Please wait while we validate your secure link...</div>
  </div>
  <div id="app-container">
    <div class="copy-container" style="display:none;">
      <button class="copy-btn" id="copyBtn">Copy Post</button>
      <button class="share-btn" id="shareBtn">Share Profile</button>
      <button class="return-btn" id="returnBtn" style="display:none;">Return To Profile</button>
    </div>
    <div class="fb-post" style="display:none;">
      <div class="fb-header">
        <img id="profilePic" src="" alt="Profile">
        <div>
          <div class="fb-user-name" id="userName">Loading Name...</div>
          <div class="fb-time">Just now</div>
        </div>
      </div>
      <div class="fb-content" id="postText">
        <p>Loading bio information...</p>
      </div>
      <div class="fb-link-preview">
        <img id="previewImage" src="" alt="Preview">
        <div class="fb-link-text">
          <div class="domain">BABYBLOOMSYDNEY.COM.AU</div>
          <div class="title" id="previewTitle">Loading Title...</div>
          <div class="description" id="previewDesc">Loading Description...</div>
        </div>
      </div>
      <div class="fb-reactions-bar">
        <div class="fb-reactions">
          <img src="https://drive.google.com/thumbnail?id=1fYJDK5-RDUYNw7smpK0TKKBxU4suCdq6&sz=w2000-h1050" class="reaction-icons-img" alt="Reactions">
          <span>12</span>
        </div>
        <div class="fb-comments-count">6 comments</div>
      </div>
      <div class="fb-footer">
        <div>Like</div><div>Comment</div><div>Share</div>
      </div>
    </div>
    <div id="data-loader" style="margin-top:20px; color:#666; display:none;">Fetching profile details...</div>
  </div>
  <script>
  const WIX_VERIFY_URL = "https://www.babybloomsydney.com.au/_functions/verifyJobToken";
  const GAS_DATA_URL = "https://script.google.com/macros/s/AKfycbyGjXWAwzlwnssUHhuwZlJM9fRG9vds927OdrCpWU6e1xtWrP4alVc8vbrpkLWV4-69TA/exec";
  const WIX_HOME_URL = "https://www.babybloomsydney.com.au";
  let globalContactId = null;
  // 1. POLLING
  window.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      if (!token) { denyAccess("Invalid Link"); return; }
      let attempts = 0;
      const pollToken = async () => {
          try {
              const response = await fetch(`${WIX_VERIFY_URL}?token=${token}`);
              const data = await response.json();
              if (data.valid === true && data.contactId) {
                  grantAccess(data.contactId);
              } else {
                  if (++attempts < 8) setTimeout(pollToken, 1000);
                  else denyAccess("Link Expired or Already Used");
              }
          } catch (err) {
              if (++attempts < 8) setTimeout(pollToken, 1000);
              else denyAccess("Connection Error");
          }
      };
      pollToken();
  });
  // 2. GRANT ACCESS
  function grantAccess(secureContactId) {
      globalContactId = secureContactId;
      const overlay = document.getElementById('security-overlay');
      overlay.style.transition = "opacity 0.5s";
      overlay.style.opacity = '0';
      setTimeout(() => {
          overlay.style.display = 'none';
          document.getElementById('app-container').style.display = 'flex';
          initializePage(secureContactId);
      }, 500);
  }
  // 3. DENY ACCESS
  function denyAccess(reason) {
      document.getElementById('sec-spinner').style.display = 'none';
      document.getElementById('sec-title').innerText = "Access Denied";
      document.getElementById('sec-title').style.color = "#c0392b";
      document.getElementById('sec-desc').innerHTML = `<strong>${reason}</strong><br>Redirecting...`;
      setTimeout(() => { window.location.href = WIX_HOME_URL; }, 3000);
  }
  // 4. FETCH DATA + DECOMPRESS CLIENT-SIDE
  async function initializePage(contactId) {
      const loader = document.getElementById('data-loader');
      loader.style.display = 'block';
      try {
          // A. Fetch Raw String from GAS
          const gasRes = await fetch(GAS_DATA_URL, {
              method: 'POST',
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify({ action: "fetchNannyShareParam", contactId: contactId })
          });
          const response = await gasRes.json();
         
          if (response.status === 'success') {
              // B. Client-Side Decompression (Your Original Logic)
              try {
                  const rawEncoded = response.encodedData;
                  const base64Data = rawEncoded.replace(/-/g, '+').replace(/_/g, '/');
                  const compressedData = atob(base64Data);
                  const compressedArray = new Uint8Array(compressedData.length);
                 
                  for (let i = 0; i < compressedData.length; i++) {
                      compressedArray[i] = compressedData.charCodeAt(i);
                  }
                 
                  const jsonString = pako.inflate(compressedArray, { to: 'string' });
                  const profileData = JSON.parse(jsonString);
                 
                  // Attach the ID since it might not be inside the compressed blob
                  profileData.contactId = contactId;
                 
                  loader.style.display = 'none';
                  renderPreview(profileData);
                 
              } catch (decodeErr) {
                  throw new Error("Decompression failed: " + decodeErr.message);
              }
          } else {
               const debugMsg = response.debug ? ` (Checked: ${response.debug.sheetIdsSeen})` : '';
               throw new Error(response.message || "Profile not found" + debugMsg);
          }
      } catch (err) {
          console.error(err);
          loader.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
      }
  }
  // 5. RENDER
  function renderPreview(data) {
      // Removed esc() for bio to allow <br> rendering; assume server-trusted data
      const profilePic = data.profilePicture || 'https://randomuser.me/api/portraits/women/44.jpg';
     
      document.getElementById('profilePic').src = profilePic;
      document.getElementById('userName').textContent = data.firstName;
      document.getElementById('previewImage').src = data.nanny_ad || profilePic;
      document.getElementById('previewTitle').textContent = `Experienced Nanny Available | ${data.suburb}`;
      document.getElementById('previewDesc').textContent = `Hi, I'm ${data.firstName} and I'm now available to Nanny!`;
     
      const bio = data.bioNanny.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
      document.getElementById('postText').innerHTML = `<p>${bio}</p>`;

      // Show elements only after rendering
      document.querySelector('.copy-container').style.display = 'flex';
      document.querySelector('.fb-post').style.display = 'block';
  }
  // 6. ACTIONS
  document.getElementById('copyBtn').addEventListener('click', async (e) => {
      const postEl = document.getElementById('postText');
      const clone = postEl.cloneNode(true);
      clone.innerHTML = clone.innerHTML.replace(/<br\s*\/?>/gi, '\n');
      const text = clone.textContent.trim();
      await navigator.clipboard.writeText(text);
      btnFeedback(e.target, 'Copied!', 'Copy Post');
  });
  document.getElementById('shareBtn').addEventListener('click', async (e) => {
      if (!globalContactId) return;
      const url = `https://babybloomsydney.com.au/nanny/${globalContactId}`;
      const data = {
          title: document.getElementById('previewTitle').textContent,
          text: document.getElementById('previewDesc').textContent,
          url: url
      };
      try { 
          await navigator.share(data); 
          btnFeedback(e.target, 'Shared!', 'Share Profile');
          document.getElementById('returnBtn').style.display = 'inline-block';

          // NEW: Send HTTP POST to Make.com webhook on successful share
          // Get Sydney timestamp (YYYY-MM-DD HH:MM:SS format)
          const sydneyTime = new Intl.DateTimeFormat('en-AU', {
            timeZone: 'Australia/Sydney',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          }).format(new Date()).replace(/\//g, '-').replace(',', '');

          const payload = {
            contactId: globalContactId,
            type: "Nanny",
            log: "initiateShareProfile",
            comment: "fbPost",
            Timestamp: sydneyTime
          };

          fetch('https://hook.eu2.make.com/tcqadoblcotjipjmlo62ozbn1elo53u3', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(response => {
            if (!response.ok) console.error('Webhook failed:', response.status);
          })
          .catch(err => console.error('Webhook error:', err));

      }
      catch (e) { 
          await navigator.clipboard.writeText(url); 
          btnFeedback(e.target, 'URL Copied!', 'Share Profile');
          // Do not show returnBtn on fallback or cancel
      }
  });
  document.getElementById('returnBtn').addEventListener('click', () => {
      if (globalContactId) window.location.href = `https://babybloomsydney.com.au/nanny/${globalContactId}`;
  });
  function btnFeedback(btn, active, reset) {
      btn.textContent = active;
      btn.classList.add('copied');
      setTimeout(() => {
          btn.textContent = reset;
          btn.classList.remove('copied');
      }, 1000);
  }
</script>
</body>
</html>
