<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanny Profile Preview</title>
  <style>
    body { background: #f0f2f5; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
    
    /* Security Overlay */
    #security-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1877F2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #sec-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #333; }
    #sec-desc { font-size: 14px; color: #666; max-width: 400px; line-height: 1.5; }

    /* App Container */
    #app-container { display: none; width: 100%; max-width: 550px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
    
    /* FB Post Styles */
    .copy-container { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; width: 100%; justify-content: center; }
    .copy-btn, .share-btn, .return-btn { background: #1877F2; color: white; border: none; padding: 8px 12px; font-size: 13px; font-weight: 600; border-radius: 6px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,.1); }
    .copy-btn:hover, .share-btn:hover, .return-btn:hover { background: #1666d1; }
    .copy-btn.copied { background: #4B8BF4; }
    
    .fb-post { width: 500px; max-width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.1); }
    .fb-header { display: flex; align-items: center; padding: 12px; }
    .fb-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .fb-header .fb-user-name { font-weight: bold; font-size: 14px; color: #050505; }
    .fb-header .fb-time { font-size: 12px; color: #65676b; }
    
    .fb-content { padding: 0 12px 12px; font-size: 14px; line-height: 1.45; color: #050505; }
    .fb-content p { margin: 0; word-break: break-word; }
    
    .fb-link-preview { border: 1px solid #ddd; border-radius: 6px; margin: 12px; overflow: hidden; background: #f8f9fa; }
    .fb-link-preview img { width: 100%; display: block; object-fit: cover; aspect-ratio: 1.91/1; }
    .fb-link-text { padding: 10px 12px; border-top: 1px solid #ddd; background: #f0f2f5; }
    .fb-link-text .domain { font-size: 12px; color: #65676b; text-transform: uppercase; margin-bottom: 2px; }
    .fb-link-text .title { font-weight: bold; font-size: 16px; color: #050505; margin-bottom: 2px; }
    .fb-link-text .description { font-size: 13px; color: #65676b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    .fb-reactions-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-top: 1px solid #ddd; font-size: 13px; color: #65676b; }
    .fb-reactions { display: inline-flex; align-items: center; gap: 5px; }
    .reaction-icons-img { width: 38px; height: 18px; }
    .fb-footer { display: flex; justify-content: space-around; border-top: 1px solid #ddd; padding: 4px 0; }
    .fb-footer div { padding: 6px 0; text-align: center; flex: 1; font-size: 14px; font-weight: 600; color: #65676b; cursor: pointer; }
    .fb-footer div:hover { background: #f2f2f2; }
    
    #data-loader { margin-top: 20px; color: #666; font-size: 14px; }
  </style>
</head>
<body>

  <!-- SECURITY OVERLAY -->
  <div id="security-overlay">
    <div class="spinner" id="sec-spinner"></div>
    <div id="sec-title">Verifying Access</div>
    <div id="sec-desc">Please wait while we validate your secure link...</div>
  </div>

  <!-- APP CONTAINER -->
  <div id="app-container">
    <div class="copy-container">
      <button class="copy-btn" id="copyBtn">Copy Post</button>
      <button class="share-btn" id="shareBtn">Share Profile</button>
      <button class="return-btn" id="returnBtn" style="display:none;">Return To Profile</button>
    </div>

    <div class="fb-post">
      <div class="fb-header">
        <img id="profilePic" src="" alt="Profile">
        <div>
          <div class="fb-user-name" id="userName">...</div>
          <div class="fb-time">Just now</div>
        </div>
      </div>
      <div class="fb-content" id="postText"><p>...</p></div>
      <div class="fb-link-preview">
        <img id="previewImage" src="" alt="Preview">
        <div class="fb-link-text">
          <div class="domain">BABYBLOOMSYDNEY.COM.AU</div>
          <div class="title" id="previewTitle">...</div>
          <div class="description" id="previewDesc">...</div>
        </div>
      </div>
      <div class="fb-reactions-bar">
        <div class="fb-reactions">
          <img src="https://drive.google.com/thumbnail?id=1fYJDK5-RDUYNw7smpK0TKKBxU4suCdq6&sz=w2000-h1050" class="reaction-icons-img" alt="Reactions">
          <span>12</span>
        </div>
        <div class="fb-comments-count">6 comments</div>
      </div>
      <div class="fb-footer">
        <div>Like</div><div>Comment</div><div>Share</div>
      </div>
    </div>
    <div id="data-loader">Fetching profile...</div>
  </div>

  <script>
    const WIX_VERIFY_URL = "https://www.babybloomsydney.com.au/_functions/verifyJobToken";
    const GAS_DATA_URL = "https://script.google.com/macros/s/AKfycbwOQdl49EEKZsWI3C1jTRCC6ticFi1yF8HnSuScIzT0R9_WmaNuznuc_NDIEQB_Cgfq/exec"; 
    const WIX_HOME_URL = "https://www.babybloomsydney.com.au";
    let globalContactId = null;

    // 1. POLLING
    window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (!token) { denyAccess("Invalid Link"); return; }

        let attempts = 0;
        const pollToken = async () => {
            try {
                const response = await fetch(`${WIX_VERIFY_URL}?token=${token}`);
                const data = await response.json();
                if (data.valid === true && data.contactId) {
                    grantAccess(data.contactId);
                } else {
                    if (++attempts < 8) setTimeout(pollToken, 1000); 
                    else denyAccess("Link Expired or Already Used");
                }
            } catch (err) {
                if (++attempts < 8) setTimeout(pollToken, 1000);
                else denyAccess("Connection Error");
            }
        };
        pollToken();
    });

    // 2. GRANT ACCESS
    function grantAccess(contactId) {
        globalContactId = contactId;
        const overlay = document.getElementById('security-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            initializePage(contactId);
        }, 500);
    }

    // 3. DENY ACCESS
    function denyAccess(reason) {
        document.getElementById('sec-spinner').style.display = 'none';
        document.getElementById('sec-title').innerText = "Access Denied";
        document.getElementById('sec-title').style.color = "#c0392b";
        document.getElementById('sec-desc').innerHTML = `<strong>${reason}</strong><br>Redirecting...`;
        setTimeout(() => { window.location.href = WIX_HOME_URL; }, 3000);
    }

    // 4. FETCH DATA
    async function initializePage(contactId) {
        const loader = document.getElementById('data-loader');
        try {
            const res = await fetch(GAS_DATA_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "fetchNannyShareParam", contactId: contactId })
            });
            const json = await res.json();
            
            // Log full debug info to console for you to see
            console.log("GAS Response:", json); 

            if (json.status === 'success') {
                loader.style.display = 'none';
                renderPreview(json.data);
            } else {
                throw new Error(json.message + (json.debug ? ` (Checked: ${json.debug.sheetIdsSeen})` : ''));
            }
        } catch (err) {
            loader.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
            console.error(err);
        }
    }

    // 5. RENDER
    function renderPreview(data) {
        const esc = (t) => t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
        
        document.getElementById('profilePic').src = data.profilePicture || '';
        document.getElementById('userName').textContent = data.firstName;
        document.getElementById('previewImage').src = data.nanny_ad || data.profilePicture || '';
        document.getElementById('previewTitle').textContent = `Experienced Nanny Available | ${data.suburb}`;
        document.getElementById('previewDesc').textContent = `Hi, I'm ${data.firstName} and I'm now available to Nanny!`;
        
        const bio = esc(data.bioNanny).replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
        document.getElementById('postText').innerHTML = `<p>${bio}</p>`;
    }

    // 6. BUTTONS
    document.getElementById('copyBtn').addEventListener('click', async (e) => {
        const postEl = document.getElementById('postText');
        const clone = postEl.cloneNode(true);
        clone.innerHTML = clone.innerHTML.replace(/<br\s*\/?>/gi, '\n');
        const text = clone.textContent.trim();
        await navigator.clipboard.writeText(text);
        btnFeedback(e.target, 'Copied!', 'Copy Post');
    });

    document.getElementById('shareBtn').addEventListener('click', async (e) => {
        if (!globalContactId) return;
        const url = `https://babybloomsydney.com.au/nanny/${globalContactId}`;
        const data = {
            title: document.getElementById('previewTitle').textContent,
            text: document.getElementById('previewDesc').textContent,
            url: url
        };
        try { await navigator.share(data); } 
        catch (e) { await navigator.clipboard.writeText(url); }
        btnFeedback(e.target, 'Shared/Copied!', 'Share Profile');
        document.getElementById('returnBtn').style.display = 'inline-block';
    });

    document.getElementById('returnBtn').addEventListener('click', () => {
        if (globalContactId) window.location.href = `https://babybloomsydney.com.au/nanny/${globalContactId}`;
    });

    function btnFeedback(btn, active, reset) {
        btn.textContent = active;
        setTimeout(() => btn.textContent = reset, 1000);
    }
  </script>
</body>
</html>
